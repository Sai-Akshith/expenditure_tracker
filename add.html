<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Entry - Spending Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="css/style.css?v=6" />
  <link rel="stylesheet" href="css/navbar.css?v=6" />
  <link rel="stylesheet" href="css/form.css?v=6" />
</head>

<body>
  <nav class="navbar">
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="add.html" class="active">Add Entry</a>
      <a href="history.html">History</a>
    </div>
    
    <div class="nav-profile">
      <span id="nav-user-email"></span>
      <button id="nav-logout-btn">Logout</button>
    </div>
  </nav>

  <main class="page">
    <h1>Add Entry</h1>

    <div class="form-page-layout">
      
      <div class="form-container">
        <form id="entry-form">
          <label for="date">Date</label>
          <input type="date" id="date" required />

          <label for="type">Type</label>
          <select id="type">
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
          </select>

          <label for="category">Category</label>
          <select id="category">
            <option>Food & Groceries</option>
            <option>Transportation</option>
            <option>Bills & Utilities</option>
            <option>Shopping</option>
            <option>Entertainment</option>
            <option>Health</option>
            <option>Education</option>
            <option>Other</option>
          </select>

          <label for="amount">Amount (₹)</label>
          <input type="number" id="amount" min="0" step="0.01" required />

          <label for="method">Payment method (optional)</label>
          <input type="text" id="method" placeholder="UPI, card, cash..." />

          <label for="description">Description (optional)</label>
          <input type="text" id="description" placeholder="e.g. Swiggy lunch" />

          <button type="submit">Save Entry</button>
        </form>

        <p style="margin-top:12px; font-size:0.85rem; color:#9ca3af; text-align: center;">
          Entries sync across all your devices using cloud storage.
        </p>
      </div>

      <div class="animation-container">
        <div id="character" class="character float-animation">
          <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master Emojis/Smilies/Face%20with%20Monocle.png" alt="Watching" class="char-state char-watching" />
          
          <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/See-No-Evil%20Monkey.png" alt="Eyes Covered" class="char-state char-typing" />
        </div>
        <p class="animation-text">I'm watching your expenses...<br>(don't worry, it's private!)</p>
      </div>

    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>

  <script src="js/firebase-init.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>

  <script>
    console.log("add.js logic injected");

    const form = document.getElementById("entry-form");
    const dateInput = document.getElementById("date");
    const character = document.getElementById("character");
    const formInputs = form.querySelectorAll("input, select");
    let typingTimer;

    // --- ANIMATION LOGIC ---
    function startTyping() {
      character.classList.add("typing-mode");
      clearTimeout(typingTimer);
    }

    function stopTyping() {
      // Delay going back to "watching" so it's not too jittery
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        character.classList.remove("typing-mode");
      }, 500); // Wait 0.5s after last input
    }

    // Attach listeners to all form fields
    formInputs.forEach(input => {
      input.addEventListener("focus", startTyping);
      input.addEventListener("input", startTyping);
      input.addEventListener("blur", stopTyping);
    });


    // --- FORM SUBMISSION LOGIC ---
    // Set default date = today
    if (!dateInput.value) {
      dateInput.valueAsDate = new Date();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!window.currentUser) {
        alert("Please login first to add entries.");
        return;
      }

      // Show watching state on submit
      stopTyping();

      const entry = {
        uid: window.currentUser.uid,
        date: dateInput.value,
        type: document.getElementById("type").value,
        category: document.getElementById("category").value,
        amount: parseFloat(document.getElementById("amount").value),
        method: document.getElementById("method").value.trim(),
        description: document.getElementById("description").value.trim(),
        createdAt: Date.now()
      };

      try {
        console.log("Saving entry →", entry);
        await addEntry(entry);
        alert("Entry saved successfully!");

        document.getElementById("amount").value = "";
        document.getElementById("method").value = "";
        document.getElementById("description").value = "";
      } catch (err) {
        console.error("❌ Error saving entry:", err);
        alert("Error saving entry. Check console.");
      }
    });
  </script>

</body>
</html>
