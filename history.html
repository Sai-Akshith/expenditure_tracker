<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>History - Spending Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/navbar.css" />
  <link rel="stylesheet" href="css/table.css" />
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a href="index.html">Home</a>
    <a href="add.html">Add Entry</a>
    <a href="history.html">History</a>
  </nav>

  <!-- AUTH Buttons -->
  <button id="login-btn">Login with Google</button>
  <button id="logout-btn" style="display:none;">Logout</button>
  <p id="user-info" style="color:#ccc; font-size:0.9rem;"></p>

  <main class="page">
    <h1>History</h1>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="history-body"></tbody>
    </table>

    <p id="empty-msg" style="margin-top:12px;font-size:0.85rem;color:#9ca3af;">
      No entries yet. Add something from the "Add Entry" page.
    </p>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>

  <!-- Project Scripts -->
  <script src="js/firebase-init.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>

  <script>
    console.log("history.js inline logic loaded");

    const tbody = document.getElementById("history-body");
    const emptyMsg = document.getElementById("empty-msg");

    // Wait for login before loading entries
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        tbody.innerHTML = "";
        emptyMsg.textContent = "Please log in to view your history.";
        return;
      }

      // Subscribe to only the logged in user's entries
      subscribeToEntries((entries) => {

        // Filter entries by uid
        const userEntries = entries.filter(e => e.uid === user.uid);

        if (userEntries.length === 0) {
          tbody.innerHTML = "";
          emptyMsg.textContent = "No entries yet.";
          return;
        }

        emptyMsg.textContent = "";
        tbody.innerHTML = "";

        userEntries.forEach(entry => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.type}</td>
            <td>${entry.category}</td>
            <td>â‚¹${entry.amount.toFixed(2)}</td>
            <td>${entry.method || "-"}</td>
            <td>${entry.description || "-"}</td>
            <td>
              <button class="edit-btn" data-id="${entry.id}">Edit</button>
              <button class="delete-btn" data-id="${entry.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Delete button
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (confirm("Delete this entry?")) {
              await deleteEntry(id);
            }
          }
        });

        // Edit button (simple edit)
        document.querySelectorAll(".edit-btn").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const newAmount = prompt("Enter new amount:");
            if (newAmount) {
              await updateEntry(id, { amount: parseFloat(newAmount) });
            }
          }
        });

      });
    });
  </script>

</body>
</html>
